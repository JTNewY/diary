{% extends 'base.html' %}
{% load static %}

{% block mainhead %}
<link rel="stylesheet" href="{% static 'main/css/style.css' %}">
{% endblock %}

{% block mainheader %}
<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">다이어리 캘린더 프로젝트</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll" aria-controls="navbarScroll" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarScroll">
                <ul class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll" style="--bs-scroll-height: 100px;">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarScrollingDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <span>{{ user.username }}님 환영합니다!</span>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarScrollingDropdown">
                            <li><a class="dropdown-item" href="#">마이페이지</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">회원정보 수정</a></li>
                            <li><a class="dropdown-item" href="#">비밀번호 변경</a></li>
                        </ul>
                    </li>
                </ul>
                <form class="d-flex">
                    <input class="form-control me-2" type="search" placeholder="검색" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">검색</button>
                </form>
            </div>
        </div>
    </nav>
</header>
{% endblock %}

{% block content %}
<div class="container">
    <div class="schedule">
        <div class="content">
            <h1 class="date" id="selectedDate">
                {{ selected_date|date:"l" }}<span>{{ selected_date|date:"F j, Y" }}</span>
            </h1>

            <div class="todos">
                <h3>일정 목록</h3>
                <ul class="eventList">
                    {% for event in events %}
                    <li class="event-card" id="event-{{ event.id }}">
                        <div class="event-header" style="background-color: {{ event.color }};">
                            <strong class="event-title">{{ event.title }}</strong>
                            <span class="event-time">
                                <script>
                                    // Moment.js를 사용하여 UTC 시간을 한국 시간(KST)으로 변환
                                    var startDate = moment("{{ event.start_date }}").utcOffset(9).format('YYYY년 MM월 DD일 HH:mm');
                                    var endDate = "{{ event.end_date|default:'' }}";
                                    if (endDate) {
                                        var endDateFormatted = moment(endDate).utcOffset(9).format('YYYY년 MM월 DD일 HH:mm');
                                    } else {
                                        var endDateFormatted = '미정';
                                    }
                                    document.write(startDate + " ~ " + endDateFormatted);
                                </script>
                            </span>
                        </div>
                        <div class="event-body">
                            <p class="event-description">{{ event.content }}</p>
                            {% if event.notification_time %}
                                <p class="event-notification">알림 시간: {{ event.notification_time|date:"Y년 m월 d일 H:i" }}</p>
                            {% endif %}
                            {% if event.add_task %}
                                <p class="event-add-task">추가 작업: {{ event.add_task }}</p>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="ui calendar">
        <div class="ui grid">
            <div class="ui sixteen column">
                <div class="button-container">
                    <button data-bs-toggle="modal" data-bs-target="#addEventModal">+</button>
                </div>
                <div id="calendar"></div>
            </div>
        </div>
    </div>


    <!-- 일정 추가 모달 -->
    <div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addEventForm">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="addEventModalLabel">새로운 작업/일정 추가</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 추가 작업 입력 -->
                        <div class="mb-3">
                            <label for="taskName" class="form-label">일정 이름</label>
                            <input type="text" class="form-control" id="taskName" placeholder="일정 이름을 입력하세요" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">설명</label>
                            <textarea class="form-control" id="taskDescription" placeholder="일정 설명을 입력하세요"></textarea>
                        </div>
                        <!-- 날짜 입력 -->
                        <div class="mb-3">
                            <label for="startDate" class="form-label">시작 일</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="startTime" class="form-label">시작 시간</label>
                            <input type="time" class="form-control" id="startTime" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label">마감 일</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endTime" class="form-label">마감 시간</label>
                            <input type="time" class="form-control" id="endTime" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskColor" class="form-label">일정 색상</label>
                            <input type="color" class="form-control" id="taskColor" value="#FFD700">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">일정 추가</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">이벤트 상세 정보</h5>
                </div>
                <div class="modal-body">
                    <p><strong>제목:</strong> <span id="eventTitle"></span></p>
                    <p><strong>시작:</strong> <span id="eventStart"></span></p>
                    <p><strong>종료:</strong> <span id="eventEnd"></span></p>
                    <p><strong>내용:</strong> <span id="eventDescription"></span></p>
                    <p><strong>색상:</strong> <span id="eventColor"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 공휴일 및 검색 섹션 -->
    <div class="search">
        <p>
            <input type="text"/>
            <button>검색</button>
        </p>
        <div class="anniversary">
            <div class="year-month text-center">
                <button><</button>
                <h2>{{ selected_date|date:"Y년 m월" }}</h2>
                <button>></button>
            </div>
            <table class="table table-striped table-hover">
                <thead>
                    <tr class="text-center">
                        <th class="col-1">#</th>
                        <th class="col-7">구분</th>
                        <th class="col-3">일</th>
                        <th class="col-5">요일</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                        <tr>
                            <td>{{ event.start_date.day }}</td>
                            <td>{{ event.title }}</td>
                            <td>{{ event.start_date|date:"d" }}일</td>
                            <td>{{ event.start_date|date:"l" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}


{% block mainjs %}
<script>
    $(document).ready(function () {
        const username = "{{ user.username }}"; // Django 템플릿에서 사용자 이름을 가져옴

        // FullCalendar 초기화
        $('#calendar').fullCalendar({
            locale: 'ko',
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,basicWeek,basicDay'
            },
            defaultDate: moment().format('YYYY-MM-DD'),
            editable: true,
            eventLimit: true,
            events: function (start, end, timezone, callback) {
                $.ajax({
                    url: `/calendar/calendar/${username}/${start.format('YYYY-MM-DD')}/${end.format('YYYY-MM-DD')}/`,
                    dataType: 'json',
                    success: function (response) {
                        if (response && response.events) {
                            // 서버 응답에서 받은 events를 FullCalendar에서 사용할 수 있는 형식으로 변환
                            const events = response.events.map(event => {
                                // 시작 날짜 및 시간을 한국 시간으로 변환 (시간 포함)
                                const startDate = moment(event.start_date).utcOffset(9).format('YYYY-MM-DD HH:mm');  // 시작 날짜 및 시간
            
                                // 종료 날짜 및 시간을 한국 시간으로 변환 (시간 포함)
                                const endDate = event.end_date ? moment(event.end_date).utcOffset(9).format('YYYY-MM-DD HH:mm') : startDate;  // 종료 날짜 및 시간
            
                                // 콘솔에 start_date와 end_date 값을 출력
                                console.log('Event:', {
                                    title: event.title,
                                    start: startDate,
                                    end: endDate,
                                    color: event.color || '#FFD700',
                                    description: event.content
                                });
            
                                return {
                                    title: event.title,
                                    start: startDate,
                                    end: endDate,
                                    color: event.color || '#FFD700', // 배경 색상
                                    textColor: '#000000', // 글씨 색상 검정색으로 설정
                                    description: event.content
                                };
                            });
            
                            // 이벤트를 FullCalendar에 표시
                            callback(events);
                        } else {
                            console.log("No events found.");
                        }
                    },
                    error: function () {
                        console.error("일정을 불러오는 중 오류가 발생했습니다.");
                    }
                });
            },
            eventClick: function(event, jsEvent, view) {
                // 클릭된 이벤트의 상세 정보를 모달에 표시
                $('#eventTitle').text(event.title);
                $('#eventStart').text(event.start.format('YYYY-MM-DD HH:mm'));
                $('#eventEnd').text(event.end ? event.end.format('YYYY-MM-DD HH:mm') : '종료 없음');
                $('#eventDescription').text(event.description || '없음');
                $('#eventColor').text(event.color || '기본 색상');
                
                // 모달을 띄운다
                $('#eventModal').modal('show');
            },
            dayClick: function (date) {
                const formattedDate = date.format('YYYY-MM-DD');
                const displayDate = date.format('dddd, MMMM D, YYYY');
                $('#selectedDate').html(`${date.format('dddd')} <span>${displayDate}</span>`);

                // 선택된 날짜에 맞는 일정을 가져오는 부분
                $.ajax({
                    url: `/calendar/calendar/${username}/${formattedDate}/`,  // 선택된 날짜의 일정 데이터를 URL 경로로 요청
                    type: 'GET',
                    success: function (response) {
                        if (response && response.events) {
                            $('.eventList').empty();  // 기존 일정 목록 비우기
                            response.events.forEach(event => {
                                // 이벤트 시간 변환 (한국 시간)
                                const startDate = moment(event.start_date).utcOffset(9).format('YYYY년 MM월 DD일 HH:mm');
                                const endDate = event.end_date ? moment(event.end_date).utcOffset(9).format('YYYY년 MM월 DD일 HH:mm') : '미정';
                                $('.eventList').append(`
                                    <li id="event-${event.id}" class="event-card">
                                        <div class="event-header" style="background-color: ${event.color};">
                                            <strong class="event-title">
                                                <span style="color: ${event.color};"></span> ${event.title}
                                            </strong>
                                            <span class="event-time"><br> ${startDate} ~<br> ${endDate}</span>
                                        </div>
                                        <div class="event-body" style="background-color: ${event.color};">
                                            <p class="event-description" style="color:black">${event.content}</p>
                                        </div>
                                    </li>
                                `);
                            });
                        } else {
                            $('.eventList').append('<li class="no-events">일정이 없습니다.</li>');
                        }
                    },
                    error: function () {
                        console.error("선택된 날짜의 일정을 불러오는 중 오류가 발생했습니다.");
                        alert("일정을 가져오는 중 오류가 발생했습니다.");
                    }
                });
            }
        });

        // 일정 추가 처리
        $('#addEventForm').on('submit', function (e) {
            e.preventDefault();

            const taskName = $('#taskName').val();
            const taskDescription = $('#taskDescription').val();
            const startDate = $('#startDate').val();
            const startTime = $('#startTime').val();
            const endDate = $('#endDate').val();
            const endTime = $('#endTime').val();
            const taskColor = $('#taskColor').val(); // 색상 값 추가

            // 유효성 검사 추가
            if (!taskName || !startDate || !startTime || !endDate || !endTime) {
                alert('일정 이름, 시작일, 시작 시간, 종료일, 종료 시간을 모두 입력해주세요.');
                return;
            }

            $.ajax({
                url: '/calendar/add_task/',  // 일정 추가 URL
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    task_name: taskName,
                    description: taskDescription,
                    start_date: startDate,
                    start_time: startTime,
                    end_date: endDate,
                    end_time: endTime,
                    color: taskColor // 색상 값 추가
                },
                success: function (response) {
                    if (response.success) {
                        // 일정을 추가한 후 다시 일정을 업데이트하여 화면에 반영
                        alert('일정이 추가되었습니다.');
                        $('#addEventModal').modal('hide');
                        $('#calendar').fullCalendar('refetchEvents'); // 새로운 이벤트를 다시 불러오기
                    } else {
                        alert('일정 추가에 실패했습니다.');
                    }
                },
                error: function () {
                    alert('일정 추가 실패');
                }
            });
        });
    });
</script>
{% endblock %}
