{% extends 'base.html' %}
{% load static %}

{% block mainhead %}
<link rel="stylesheet" href="{% static 'main/css/style.css' %}">
{% endblock %}

{% block mainheader %}
<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Diary Calendar Project</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll" aria-controls="navbarScroll" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarScroll">
                <ul class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll" style="--bs-scroll-height: 100px;">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarScrollingDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                           
                            <span>{{ user.username }}님 환영합니다!</span>  <!-- 커스텀 유저 모델에서 'username' 사용 -->
                    
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarScrollingDropdown">
                            <li><a class="dropdown-item" href="#">마이페이지</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">회원정보 수정</a></li>
                            <li><a class="dropdown-item" href="#">비밀번호 변경</a></li>
                        </ul>
                    </li>
                </ul>
                <form class="d-flex">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>
</header>
{% endblock %}

{% block content %}
<div class="container">
    <div class="schedule">
        <div class="content">
            <!-- 선택된 날짜를 동적으로 표시 -->
            <h1 class="date" id="selectedDate">
                {{ selected_date|date:"l" }}<span>{{ selected_date|date:"F j, Y" }}</span>
            </h1>

            <!-- To-Do List 섹션 -->
            <div class="todos">
                <h3>To-Do List</h3>
                <p>
                    <input type="text" placeholder="Add a new task" id="newTodoInput" style="flex: 1;"/>
                    <button id="addTodoBtn" class="btn btn-success">Add To-Do</button>
                </p>
                <ul class="todoList">
                    {% for todo in todos %}
                        <li id="todo-{{ todo.id }}">
                            <input type="checkbox" {% if todo.is_completed %}checked{% endif %} data-todo-id="{{ todo.id }}">
                            {{ todo.task }}
                            <a href="#" class="removeTodo btn btn-danger btn-sm" data-todo-id="{{ todo.id }}">x</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- 캘린더 표시 영역 -->
    <div class="ui calendar">
        <!-- 몇 가지 알림을 미리 표시 -->
        <div class="alert alert-primary" role="alert">
            <h4>D-5 생일</h4>
        </div>
        <div class="alert alert-primary" role="alert">
            <h4>D-8 자격증 시험</h4>
        </div>
        <div class="alert alert-primary" role="alert">
            <h4>D-13 크리스마스 파티</h4>
        </div>
        <div class="ui grid">
            <div class="ui sixteen column">
                <div class="button-container">
                    <button>+</button>
                </div>
                <div id="calendar"></div> <!-- 이곳에 FullCalendar가 렌더링됩니다 -->
            </div>
        </div>
    </div>

    <!-- 검색 및 공휴일 섹션 -->
    <div class="search">
        <p>
            <input type="text"/>
            <button>검색</button>
        </p>
        <div class="anniversary">
            <div class="year-month text-center">
                <button><</button>
                <h2>{{ selected_date|date:"Y년 m월" }}</h2>
                <button>></button>
            </div>
            <table class="table table-striped table-hover">
                <thead>
                    <tr class="text-center">
                        <th class="col-1">#</th>
                        <th class="col-7">구분</th>
                        <th class="col-3">일</th>
                        <th class="col-5">요일</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                        <tr>
                            <td>{{ event.start_date.day }}</td>
                            <td>{{ event.title }}</td>
                            <td>{{ event.start_date|date:"d" }}일</td>
                            <td>{{ event.start_date|date:"l" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block mainjs %}
<script>
    $(document).ready(function () {
        // FullCalendar 초기화
        $('#calendar').fullCalendar({
            locale: 'ko',  // 한국어 로케일 설정
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,basicWeek,basicDay'
            },
            defaultDate: moment().format('YYYY-MM-DD'),  // 기본 날짜는 오늘로 설정
            editable: true,
            eventLimit: true,  // 일정이 많을 경우 'more' 링크 표시
            events: function (start, end, timezone, callback) {
                $.ajax({
                    url: '/calendar/',  // AJAX로 이벤트와 To-Do를 가져옵니다
                    data: { selected_date: start.format('YYYY-MM-DD') },
                    dataType: 'json',
                    success: function (response) {
                        const events = response.events.map(event => ({
                            title: event.title,
                            start: event.start_date,
                            color: '#FFD700'  // 이벤트 색상 설정
                        }));
                        callback(events);
                    }
                });
            },
            dayClick: function (date) {
                const formattedDate = date.format('YYYY-MM-DD');
                const displayDate = date.format('dddd, MMMM D, YYYY');
    
                // 선택된 날짜 업데이트
                $('#selectedDate').html(`${date.format('dddd')} <span>${displayDate}</span>`);
    
                // 선택한 날짜의 To-Do 리스트 불러오기
                $.ajax({
                    url: '/calendar/',  // 선택한 날짜의 To-Do 가져오기
                    type: 'GET',
                    data: { selected_date: formattedDate },  // 선택한 날짜 전송
                    success: function (response) {
                        // 기존 To-Do 리스트 초기화
                        $('.todoList').empty();

                        // 새 To-Do 리스트 추가
                        response.todos.forEach(todo => {
                            $('.todoList').append(`
                                <li id="todo-${todo.id}">
                                    <input type="checkbox" ${todo.completed ? 'checked' : ''} data-todo-id="${todo.id}">
                                    ${todo.task}
                                    <a href="#" class="removeTodo btn btn-danger btn-sm" data-todo-id="${todo.id}">x</a>
                                </li>
                            `);
                        });
                    }
                });
            }
        });
    
        // To-Do 추가
        $('#addTodoBtn').on('click', function () {
            const newTask = $('#newTodoInput').val();
            const selectedDate = $('#selectedDate').text();
    
            if (newTask.trim() !== '') {
                $.ajax({
                    url: '/add_todo/',  // To-Do 추가 처리 URL
                    type: 'POST',
                    data: {
                        task: newTask,
                        date: selectedDate,
                        csrfmiddlewaretoken: '{{ csrf_token }}'  // Django CSRF Token
                    },
                    success: function (response) {
                        // 새로고침 없이 To-Do 리스트 갱신
                        $('.todoList').append(`
                            <li id="todo-${response.id}">
                                <input type="checkbox" data-todo-id="${response.id}">
                                ${response.task}
                                <a href="#" class="removeTodo btn btn-danger btn-sm" data-todo-id="${response.id}">x</a>
                            </li>
                        `);
                        $('#newTodoInput').val('');  // 입력 필드 초기화
                    }
                });
            }
        });
    
        // To-Do 삭제
        $(document).on('click', '.removeTodo', function () {
            const todoItem = $(this).closest('li');
            const todoId = $(this).data('todo-id');
    
            $.ajax({
                url: '/delete_todo/',  // To-Do 삭제 처리 URL
                type: 'POST',
                data: {
                    todo_id: todoId,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    todoItem.remove();
                }
            });
        });
    });
</script>
{% endblock %}
